<html>
  <head>
    <base target="_top">
    <script>
      // Get the accent color dynamically
      var accentColors = <?!= JSON.stringify(getAccentColor()) ?>;
      var fSize = <?!= JSON.stringify(getFontSize()) ?>;

      // Set the CSS variables
      document.documentElement.style.setProperty('--accent-color', accentColors.color);
      document.documentElement.style.setProperty('--accent-color-hover', accentColors.hover);
      document.documentElement.style.setProperty('--font-size', fSize);
    </script>
    <?!= include('defaultStyles'); ?>
    <?!= include('viewWritingModeStyles'); ?>
  </head>
  <body>
    <div class="back-btn-container">
      <a href="#" class="back-btn" onclick="navigateTo('landingPage')">Back</a>
      <input type="text" id="searchBar" placeholder="Search entities..." oninput="filterEntities()" />
    </div>

    <div id="loading"> Loading... </div>
    <div id="container"></div>

<script>
  function determineCatalog(entityName) {
  for (const catalog in window.cache.catalogData) {
    if (window.cache.catalogData[catalog].includes(entityName)) {
      return catalog;
    }
  }
  return "Characters"; // fallback if not found
}

  function navigateTo(page) {
      google.script.run.showPage(page);
    }

  function loadTrackedRanges() {
    const raw = sessionStorage.getItem("loggedRanges");
    if (!raw) {
      console.log("No existing loggedRanges cache found. Initializing empty structure.");
      sessionStorage.setItem("loggedRanges", JSON.stringify({}));
      return {};
    }
    const parsed = JSON.parse(raw);
    const result = {};
    for (const entity in parsed) {
      result[entity] = new Set(parsed[entity]);
    }
    return result;
  }

  function saveTrackedRanges(tracked) {
    const obj = {};
    for (const entity in tracked) {
      obj[entity] = Array.from(tracked[entity]);
    }
    sessionStorage.setItem("loggedRanges", JSON.stringify(obj));
  }

  function safeParse(key) {
    try {
      const raw = localStorage.getItem(key) || sessionStorage.getItem(key);
      if (!raw || raw === "undefined") return null;
      return JSON.parse(raw);
    } catch (e) {
      console.warn(`Failed to parse JSON for key: ${key}`, e);
      return null;
    }
  }

  const displayedEntities = new Set();
  const trackedRanges = loadTrackedRanges();
  const namedEntities = new Set();
  const worldId = localStorage.getItem("worldId") || "default";

  const defaultCache = {
    catalogData: {},
    entityData: {},
    radarData: {},
    existingEntities: [],
    ignoredEntities: []
  };

  const sessionCache = safeParse(`cachedData-${worldId}`) || {};
  const localCache = safeParse(`cachedData-${worldId}`) || {};
  const existingFromLocal = safeParse(`existingEntities-${worldId}`) || [];
  const ignoredFromLocal = safeParse(`ignoredEntities-${worldId}`) || [];

  window.cache = {
    ...defaultCache,
    ...localCache,
    ...sessionCache,
    existingEntities: [...new Set([...(sessionCache.existingEntities || []), ...existingFromLocal])],
    ignoredEntities: [...new Set([...(sessionCache.ignoredEntities || []), ...ignoredFromLocal])]
  };

  sessionStorage.setItem(`cachedData-${worldId}`, JSON.stringify(window.cache));
  console.log("Final merged cache:", window.cache);

  document.addEventListener('DOMContentLoaded', function () {
  console.log("Page loaded. Starting background logging interval...");

  setInterval(() => {
    const existingEntities = Array.isArray(window.cache.existingEntities) ? window.cache.existingEntities : [];
    console.log("Background logging for existingEntities:", existingEntities);

    existingEntities.forEach(entityName => {
      console.log(`Refreshing named ranges for ${entityName}`);
      google.script.run.withSuccessHandler(() => {
        fetchAndLogRangeInfo(entityName);
      }).createNamedRangesForCharacter(entityName);

    }, 7000);

    google.script.run.withSuccessHandler(function (newProperNouns) {
      if (!newProperNouns) return;
      console.log("Detected new proper nouns:", newProperNouns);

      newProperNouns.forEach(entityName => {
        const isExisting = window.cache.existingEntities.includes(entityName);
        const isIgnored = window.cache.ignoredEntities.includes(entityName);

        if (!displayedEntities.has(entityName) && !isExisting && !isIgnored) {
          displayedEntities.add(entityName);
          console.log(`Prompting user for new entity: ${entityName}`);
          addNewDiv(entityName);
        }
      });
    }).getNewProperNouns();

  }, 5000);
});

function fetchAndLogRangeInfo(entityName) {
  const catalog = determineCatalog(entityName);
  if (!trackedRanges[entityName]) trackedRanges[entityName] = new Set();

  google.script.run.withSuccessHandler(function (existingFirestoreRangeIds) {
    google.script.run.withSuccessHandler(function (infos) {
      if (!infos || infos.length === 0) return;

      infos.forEach(info => {
        const rangeName = info.rangeName;
        const excerpt = info.excerpt;

        const isAlreadyInFirestore = existingFirestoreRangeIds.includes(rangeName);

        //Rely on Firestore; cache is secondary (prevents re-logging in this session)
        if (!isAlreadyInFirestore) {
          console.log(`Logging ${rangeName} for ${entityName} (${catalog})`);

          google.script.run.withSuccessHandler(() => {
            trackedRanges[entityName].add(rangeName); // Add to cache AFTER success
            saveTrackedRanges(trackedRanges);
            console.log(`Logged ${rangeName} for ${entityName}`);
          }).logNarrativeMentionWithRange(catalog, entityName, rangeName, excerpt);
        } else {
          console.log(`Skipped: ${rangeName} for ${entityName} (already in Firestore)`);
        }
      });
    }).getAllNamedRangesForEntity(entityName);
  }).getLoggedRangeIds(catalog, entityName);
}



  function addNewDiv(entityName) {
    const container = document.getElementById('container');
    const loadingMsg = document.getElementById('loading');

    if (loadingMsg) {
      loadingMsg.style.display = 'none'; // Hide once we add something
    }
    if (!container) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'entity-container';

    const nameSpan = document.createElement('span');
    nameSpan.textContent = entityName;

    const buttonGroup = document.createElement('div');
    buttonGroup.className = 'button-group';

    function createCatalogButton(label, type) {
      const btn = document.createElement('button');
      btn.textContent = label;
      btn.onclick = function () {
        google.script.run.withSuccessHandler(() => {
          if (!window.cache.catalogData[type]) window.cache.catalogData[type] = [];
          if (!window.cache.catalogData[type].includes(entityName)) {
            window.cache.catalogData[type].push(entityName);
          }
          if (!window.cache.existingEntities.includes(entityName)) {
            window.cache.existingEntities.push(entityName);
          }

          const existingCache = safeParse(`cachedData-${worldId}`) || {};
          const mergedCatalogData = {
            ...existingCache.catalogData,
            ...window.cache.catalogData,
            [type]: [...new Set([...(existingCache.catalogData?.[type] || []), ...(window.cache.catalogData?.[type] || [])])]
          };
          const mergedCache = {
            ...existingCache,
            ...window.cache,
            catalogData: mergedCatalogData,
            existingEntities: [...new Set([...(existingCache.existingEntities || []), ...window.cache.existingEntities])]
          };

          window.cache = mergedCache;
          sessionStorage.setItem(`cachedData-${worldId}`, JSON.stringify(mergedCache));
          localStorage.setItem(`existingEntities-${worldId}`, JSON.stringify(mergedCache.existingEntities));

          wrapper.remove();
        }).addCatalogEntity(type, entityName);
      };
      return btn;
    }

    buttonGroup.appendChild(createCatalogButton('Character', 'Characters'));
    buttonGroup.appendChild(createCatalogButton('Location', 'Locations'));
    buttonGroup.appendChild(createCatalogButton('Event', 'Events'));

    const ignoreBtn = document.createElement('button');
    ignoreBtn.textContent = 'Ignore';
    ignoreBtn.onclick = function () {
      google.script.run.withSuccessHandler(() => {
        localStorage.setItem(`ignoredEntities-${worldId}`, JSON.stringify(window.cache.ignoredEntities));
        wrapper.remove();
      }).addIgnoredEntity(entityName);
    };

    buttonGroup.appendChild(ignoreBtn);
    wrapper.appendChild(nameSpan);
    wrapper.appendChild(buttonGroup);
    container.appendChild(wrapper);
    filterEntities();
  }

  function filterEntities() {
    const searchTerm = document.getElementById('searchBar').value.toLowerCase();
    const allEntities = document.querySelectorAll('.entity-container');
    allEntities.forEach(entity => {
      const name = entity.querySelector('span').textContent.toLowerCase();
      entity.style.display = name.includes(searchTerm) ? '' : 'none';
    });
  }
</script>

  </body>
</html>