<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <?!= include('viewCatalogsStyles'); ?>
    <?!= include('defaultStyles'); ?>

    <script>
      // Display each catalog
      function loadCatalogs() {
        google.script.run.withSuccessHandler(displayCatalogs).getCatalogs();
      }

      function displayCatalogs(catalogs) {
        let list = document.getElementById("catalogList");

        let addButton = document.getElementById("addEntity");
        if (!addButton) {
          addButton = document.createElement("li");
          addButton.id = "addEntity";
          addButton.textContent = "Add an Entity";
          addButton.onclick = function () {
            showAddEntity();
          };
        }

        // Clear previous items
        list.innerHTML = ""; 

        catalogs.forEach((catalog) => {
          let li = document.createElement("li");
          li.innerHTML = `<span onclick="toggleCatalog('${catalog}')">${catalog} ▼</span>`;
          
          let sublist = document.createElement("ul");
          sublist.id = `data-${catalog}`;
          sublist.style.display = "none"; // Initially hidden
          
          li.appendChild(sublist);
          list.appendChild(li);
        });
        list.appendChild(addButton);

        window.catalogsList = catalogs;
      }

      // Display each catalog's items
      function displayCatalogData(catalog, response) {
        console.log("Data received for catalog:", catalog, response);

        let sublist = document.getElementById(`data-${catalog}`);
        sublist.innerHTML = ""; // Clear old data

        //Fix: Extract data from response object
        let data = response.data; 

        if (!Array.isArray(data) || data.length === 0) {
            sublist.innerHTML = "<li>No data found</li>"; // Show message if empty
            return;
        }

        data.forEach((item) => {
          let li = document.createElement("li");
          let span = document.createElement("span");
          span.textContent = item;
          span.style.display = "block";
          span.style.cursor = "pointer";
          span.onclick = function () {
            showEntityDetails(catalog, item);
          };

          li.appendChild(span);
          sublist.appendChild(li);
        });
      }

      //Delete Entities
      function deleteEntity(catalog, entity, listItem) {
        let confirmDelete = confirm(`Are you sure you want to delete "${entity}" from ${catalog}?`);
        if (!confirmDelete) return;

        google.script.run.withSuccessHandler(() => {
          listItem.remove(); // Remove from UI
        }).deleteCatalogEntity(catalog, entity);
      }

      //Adding Entities
      function showAddEntity() {
        let modal = document.getElementById("addEntityModal");
        let select = document.getElementById("catalogDropdown");

        // Clear existing dropdown options
        select.innerHTML = "";

        // Add each catalog as an option
        window.catalogsList.forEach(catalog => {
          let option = document.createElement("option");
          option.value = catalog;
          option.textContent = catalog;
          select.appendChild(option);
        });

        modal.style.display = "block"; // Show modal
      }

      function closeModal(name) {
        document.getElementById(name).style.display = "none";
      }

      function submitNewEntity() {
        let catalog = document.getElementById("catalogDropdown").value;
        let entityName = document.getElementById("entityName").value.trim();

        if (!entityName) {
          alert("Please enter a valid entity name.");
          return;
        }

        google.script.run.withSuccessHandler(() => {
          alert(`Entity "${entityName}" added to ${catalog}`);
          closeModal("addEntityModal");
          loadCatalogs(); // Refresh list
        }).addCatalogEntity(catalog, entityName);
      }

      function showUpdateEntity(catalog, entity) {
        let modal = document.getElementById("showEntityModal");

        if (!modal) {
          console.log("Error: Modal element not found!");
          return;
        }

        let select = document.getElementById("fieldDropdown");
        select.innerHTML = ""; // Clear previous options

        select.setAttribute("data-catalog", catalog);
        select.setAttribute("data-entity", entity);

        // Call Firestore to get document fields
        google.script.run.withSuccessHandler((fields) => {
          if (!fields || Object.keys(fields).length === 0) {
            select.innerHTML = "<option>No fields found</option>";
            return;
          }

          // Populate dropdown with field names
          Object.keys(fields).forEach(fieldName => {
            let option = document.createElement("option");
            option.value = fieldName;
            option.textContent = fieldName;
            select.appendChild(option);
          });

          modal.style.display = "block"; 
        }).getDocumentFields(catalog, entity);
      }

      function updateEntity() {
        let catalog = document.getElementById("fieldDropdown").getAttribute("data-catalog");
        let entity = document.getElementById("fieldDropdown").getAttribute("data-entity");
        let field = document.getElementById("fieldDropdown").value;
        let newValue = document.getElementById("fieldName").value.trim();
        console.log("Catalog:", catalog);
        console.log("Entity:", entity);
        console.log("Field:", field);
        console.log("New Value:", newValue);

        if (!catalog || !entity || !field || !newValue) {
          alert("Please select a field and enter a new value.");
          return;
        }

        let updateData = {};
        updateData[field] = { stringValue: newValue };  // Firestore format

        console.log(`Updating ${field} in ${entity} (Catalog: ${catalog}) to: ${newValue}`);

        google.script.run.withSuccessHandler(() => {
          alert(`"${field}" updated successfully!`);
          closeModal("showEntityModal");
          loadCatalogs(); // Refresh list
        }).updateCatalogEntity(catalog, entity, updateData);
      }

      //Get data
      function toggleCatalog(catalog) {
        console.log("Clicked category:", catalog); // Debugging log

        let sublist = document.getElementById(`data-${catalog}`);
        
        if (!sublist) {
            console.log("Error: Sublist element not found for", catalog);
            return;
        }

        if (sublist.style.display === "none") {
          google.script.run.withSuccessHandler((data) => {
              console.log("Received data for", catalog, data); // Debugging log
              displayCatalogData(catalog, data);
          }).getCatalogData(catalog);

          sublist.style.display = "block"; // Expand
        } else {
          sublist.style.display = "none"; // Collapse
        }
      }

    function showEntityDetails(catalog, entityName) {
      google.script.run.withSuccessHandler((entityData) => {
        const modal = document.getElementById("viewEntityModal");
        const nameDisplay = document.getElementById("viewEntityName");
        const attributesList = document.getElementById("entityAttributesList");
        const occurrencesList = document.getElementById("entityOccurencesList");

        modal.setAttribute("data-entity", entityName);

        // nameDisplay.textContent = `Catalog: ${catalog} — ${entityName}`;
        nameDisplay.textContent = `${entityName}`;

        // Clear previous
        attributesList.innerHTML = ""; 
        occurrencesList.innerHTML = "";

        if (!entityData || Object.keys(entityData).length === 0) {
          attributesList.innerHTML = "<li>No data available</li>";
          occurrencesList.innerHTML = "<li>No data available</li>";
        } else {
          const attributesOrder = [
            "HairColor",
            "EyeColor",
            "SkinColor",
            "Weight",
            "Build",
            "DistinctFeatures",
            "Height",
            // "Name",
            "Gender",
            "Age",
            "Nationality",
            "Aliases",
            "Accessories"
          ];

          const occurencesOrder = [
            "StoryAppearances"
          ];

          attributesOrder.forEach((key) => {
            if (entityData.hasOwnProperty(key)) {
              const li = document.createElement("li");
              let value = entityData[key];

              // Format arrays
              if (Array.isArray(value)) {
                value = value.join(", ");
              }

              const formattedKey = key
                // reformats 'camelCase' to 'Camel Case'
                .replace(/([a-z])([A-Z])/g, "$1 $2") // Add space
                .replace(/^./, (char) => char.toUpperCase()); // Capitalize first letter

              li.innerHTML = `<strong>${formattedKey}:</strong> ${value}`;
              attributesList.appendChild(li);
            }
          });

          occurencesOrder.forEach((key) => {
            if (entityData.hasOwnProperty(key)) {
              const li = document.createElement("li");
              let value = entityData[key];

              // Format arrays
              if (Array.isArray(value)) {
                value = value.join(", ");
              }

              const formattedKey = key
                // reformats 'camelCase' to 'Camel Case'
                .replace(/([a-z])([A-Z])/g, "$1 $2") // Add space
                .replace(/^./, (char) => char.toUpperCase()); // Capitalize first letter

              li.innerHTML = `<strong>${formattedKey}:</strong> ${value}`;
              occurrencesList.appendChild(li);
            }
          });
        }

        modal.style.display = "block";
      }).getCatalogEntity(catalog, entityName); 
    }

    function openTab(evt, tabInfo) {
      console.log("Switching to " + tabInfo);
      // Declare all variables
      var i, tabcontent, tablinks;

      // Get all elements with class="tabcontent" and hide them
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      // Get all elements with class="tablinks" and remove the class "active"
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }

      // Show the current tab, and add an "active" class to the button that opened the tab
      document.getElementById(tabInfo).style.display = "block";
      evt.currentTarget.className += " active";

      // If the Graphs tab is opened, get the radar chart data and render the chart
      if (tabInfo == 'Graphs') {
        const modal = document.getElementById("viewEntityModal");
        const entityName = modal.getAttribute("data-entity");
        if (entityName) {
          console.log("Rendering chart of... " + entityName);
          loadRadarChart(entityName);
        } else {
          console.error("Entity name not set in the modal data attribute");
        }
      }
    }

    function loadRadarChart(entityName) {
      // Log the passed entityName for debugging
      console.log("Calling getRadarData for:", entityName);

      google.script.run
        .withSuccessHandler(function(data) {
          console.log("Radar data received:", data);
          renderChart(data);
        })
        .withFailureHandler(function(error) {
          console.error("Error calling getRadarData:", error);
        })
        .getEntityAttribute('Characters', entityName, 'PersonalityTraits');
    }
    
    window.onload = loadCatalogs; 

    // summary tab is open upon loading up a character
    document.addEventListener("DOMContentLoaded", function(event) { 
      document.getElementById("summaryButton").click();
    });
    </script>
  </head>

  <body>
    <div class="back-btn-container">
      <a href="#" class="back-btn" onclick="navigateTo('landingPage')">Back</a>
    </div>
   
    <h1>Choose a Catalog to Display:</h1>
    <input type="text" id="searchInput" onkeyup="filterCatalogs()" placeholder="Search catalogs...">

    <ul id = "catalogList">
      <li id="addEntity" onclick="showAddEntity()">Add an Entity</li>
    </ul>

    <div id="addEntityModal" class="modal-container">
      <div class="modal-popup">
        <span class="close" onclick="closeModal('addEntityModal')">&times;</span>
        <h2>Add a New Entity</h2>

        <label for="catalogDropdown">Select Catalog:</label>
        <select id="catalogDropdown"></select>

        <br><br>

        <label for="entityName">Enter Entity Name:</label>
        <input type="text" id="entityName" placeholder="Entity name">

        <br><br>

        <button onclick="submitNewEntity()">Add Entity</button>
        <button onclick="closeModal('addEntityModal')">Cancel</button>
      </div>
    </div>

    <div id="showEntityModal" class="modal-container">
      <div class="modal-popup">
        <span class="close" onclick="closeModal('showEntityModal')">&times;</span>
        <h2>Add a New Entity</h2>

        <label for="fieldDropdown">Select Catalog:</label>
        <select id="fieldDropdown"></select>

        <br><br>

        <label for="fieldName">Enter New Field Value:</label>
        <input type="text" id="fieldName" placeholder="field name">

        <br><br>

        <button onclick="updateEntity()">Update Entity</button>
        <button onclick="closeModal('showEntityModal')">Cancel</button>
      </div>
    </div>

    <div id="viewEntityModal" class="modal-container">
      <div class="modal-popup">
        <div class="modal-content">
          <h2 class="character-name" id="viewEntityName" style="font-weight: bold;"></h2>
          <p class="close" onclick="closeModal('viewEntityModal')">&times;</p>
          

          <div class="tab">
            <button class="tablinks" id="summaryButton" onclick="openTab(event, 'Summary')">Summary</button>
            <button class="tablinks" onclick="openTab(event, 'Attributes')">Details</button>
            <button class="tablinks" onclick="openTab(event, 'Graphs')">Graphs</button>
            <button class="tablinks" onclick="openTab(event, 'Occurences')">Occurences</button>
            <!-- <button class="tablinks" onclick="openTab(event, 'Relationships')">Relationships</button> -->
          </div>

          <div id="Summary" class="tabcontent">
            <p>placeholder text</p>
            <button class="accent-btn" onclick="deleteCatalogEntity()" style="background-color: #c9807b"> Delete Entity </button>
          </div>

          <div id="Attributes" class="tabcontent">
            <ul class="character-information" id="entityAttributesList"></ul>
          </div>

          <div id="Graphs" class="tabcontent">
            <canvas id="radarChart"></canvas>
          </div> 

          <div id="Occurences" class="tabcontent">
            <ul class="character-information" id="entityOccurencesList"></ul>
          </div>

        </div>
      </div>
    </div>

    <script>
      function renderChart(data) {
        console.log("Radar chart data received:", data.fields);
        const data2 = data.fields;
        const labels = [];
        const values = [];

        for (const trait in data2) {
          if (data2.hasOwnProperty(trait)) {
            labels.push(trait);
            values.push(parseInt(data2[trait].integerValue));
          }
        }
        
        // Clear any previous chart instance (optional, if needed)
        const canvas = document.getElementById('radarChart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Personality Traits',
              data: values,
              fill: true,
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderColor: 'rgba(54, 162, 235, 1)',
              pointBackgroundColor: 'rgba(54, 162, 235, 1)'
            }]
          },
          options: {
            scales: {
              r: {
                beginAtZero: true,
                min: 0,
                max: 100
              }
            }
          }
        });
      }
    </script>



    <script>
    function navigateTo(page) {
      google.script.run.showPage(page);
    }
    </script>
  </body>
</html>
